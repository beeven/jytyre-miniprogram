"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
App({
    globalData: {
        useCloud: true
    },
    onLaunch: function () {
        if (!wx.cloud) {
            console.error('请使用 2.2.3 或以上的基础库以使用云能力');
        }
        else {
            wx.cloud.init({
                traceUser: true,
            });
        }
    },
    ensureLogin: function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (_this.globalData.openid !== null && typeof (_this.globalData.openid) !== "undefined") {
                wx.checkSession({
                    success: function () {
                        resolve(_this.globalData.openid);
                    },
                    fail: function () {
                        doLogin().then(function (openid) { resolve(openid); }).catch(function (err) { reject(err); });
                    }
                });
            }
            else {
                doLogin().then(function (openid) { resolve(openid); }).catch(function (err) { reject(err); });
            }
        });
    },
    getUserInfo: function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            wx.getSetting({
                success: function (res) {
                    if (res.authSetting["scope.userInfo"]) {
                        updateUserInfo().then(function (info) {
                            resolve(info);
                        });
                    }
                    else {
                        _this.ensureLogin().then(function () {
                            return updateUserInfo()
                                .then(function (info) {
                                resolve(info);
                            });
                        });
                    }
                },
                fail: function (err) {
                    reject(err);
                }
            });
        });
    }
});
function doLogin() {
    var app = getApp();
    return new Promise(function (resolve, reject) {
        wx.login({
            success: function (res) {
                if (res.code) {
                    if (app.globalData.useCloud) {
                        getOpenIDCloud().then(function (openid) {
                            resolve(openid);
                        });
                    }
                    else {
                        getOpenIDServer(res.code).then(function (openid) {
                            resolve(openid);
                        });
                    }
                }
            },
            fail: function (err) {
                reject(err);
            }
        });
    });
}
function getOpenIDCloud() {
    return new Promise(function (resolve, reject) {
        var app = getApp();
        wx.cloud.callFunction({
            name: 'login',
            data: {},
            success: function (res) {
                var openid = res.result.openid;
                app.globalData.openid = openid;
                resolve(openid);
            },
            fail: function (err) {
                reject(err);
            }
        });
    });
}
function getOpenIDServer(code) {
    return new Promise(function (resolve, reject) {
        var app = getApp();
        wx.request({
            url: 'https:/xxxxx/xxxx',
            data: {
                code: code
            },
            success: function (res) {
                app.globalData.openid = res.data.openid;
                resolve(res.data);
            },
            fail: function (err) {
                reject(err);
            }
        });
    });
}
function updateUserInfo() {
    return new Promise(function (resolve, reject) {
        var app = getApp();
        wx.getUserInfo({
            success: function (res) {
                app.globalData.userInfo = res.userInfo;
                resolve(res.userInfo);
            },
            fail: function (err) {
                reject(err);
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBa0JBLEdBQUcsQ0FBQztJQUNGLFVBQVUsRUFBRTtRQUNWLFFBQVEsRUFBRSxJQUFJO0tBQ0s7SUFDckIsUUFBUTtRQUNOLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO1NBQ3pDO2FBQU07WUFDTCxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztnQkFDWixTQUFTLEVBQUUsSUFBSTthQUNoQixDQUFDLENBQUE7U0FHSDtJQUNILENBQUM7SUFFRCxXQUFXO1FBQVgsaUJBZUM7UUFkQyxPQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDakMsSUFBSSxLQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxJQUFJLElBQUksT0FBTyxDQUFDLEtBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssV0FBVyxFQUFFO2dCQUN0RixFQUFFLENBQUMsWUFBWSxDQUFDO29CQUNkLE9BQU8sRUFBRTt3QkFDUCxPQUFPLENBQUMsS0FBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDbEMsQ0FBQztvQkFDRCxJQUFJLEVBQUU7d0JBQ0osT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUEsTUFBTSxJQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUcsSUFBTyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDaEYsQ0FBQztpQkFDRixDQUFDLENBQUE7YUFDSDtpQkFBTTtnQkFDTCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQSxNQUFNLElBQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBLENB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RSxNQUFNO1FBQ2pDLElBQU0sR0FBRyxHQUFHLE1BQU0sRUFBVSxDQUFDO1FBQzdCLEVBQUUsQ0FBQyxPQUFPLENBQUM7WUFDVCxHQUFHLEVBQUUsbUJBQW1CO1lBQ3hCLElBQUksRUFBRTtnQkFDSixJQUFJLEVBQUUsSUFBSTthQUNYO1lBQ0QsT0FBTyxFQUFFLFVBQUEsR0FBRztnQkFDVixHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUNuQixDQUFDO1lBQ0QsSUFBSSxFQUFFLFVBQUEsR0FBRztnQkFDUCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDZCxDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsU0FBUyxjQUFjO0lBQ3JCLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtRQUNqQyxJQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQztRQUM3QixFQUFFLENBQUMsV0FBVyxDQUFDO1lBQ2IsT0FBTyxFQUFFLFVBQUEsR0FBRztnQkFDVixHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO2dCQUN2QyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3hCLENBQUM7WUFDRCxJQUFJLEVBQUUsVUFBQSxHQUFHO2dCQUNQLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNkLENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgaW50ZXJmYWNlIElNeUFwcEdsb2JhbERhdGEge1xyXG4gIHVzZXJJbmZvPzogd3guVXNlckluZm8sXHJcbiAgdXNlQ2xvdWQ6IGJvb2xlYW4sXHJcbiAgb3BlbmlkPzogc3RyaW5nLFxyXG4gIHBob25lTnVtYmVyPzogc3RyaW5nLFxyXG4gIHRlc3Q/OiBzdHJpbmcgfCBvYmplY3QsXHJcbiAgW2tleTogc3RyaW5nXTogYW55XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSU15QXBwIHtcclxuICB1c2VySW5mb1JlYWR5Q2FsbGJhY2s/KHJlczogd3guVXNlckluZm8pOiB2b2lkO1xyXG5cclxuICBnbG9iYWxEYXRhOiBJTXlBcHBHbG9iYWxEYXRhO1xyXG5cclxuICBlbnN1cmVMb2dpbigpOiBQcm9taXNlPGFueT47XHJcbiAgZ2V0VXNlckluZm8oKTogUHJvbWlzZTxhbnk+O1xyXG59XHJcblxyXG5BcHAoe1xyXG4gIGdsb2JhbERhdGE6IHtcclxuICAgIHVzZUNsb3VkOiB0cnVlXHJcbiAgfSBhcyBJTXlBcHBHbG9iYWxEYXRhLFxyXG4gIG9uTGF1bmNoKCkge1xyXG4gICAgaWYgKCF3eC5jbG91ZCkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCfor7fkvb/nlKggMi4yLjMg5oiW5Lul5LiK55qE5Z+656GA5bqT5Lul5L2/55So5LqR6IO95YqbJylcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHd4LmNsb3VkLmluaXQoe1xyXG4gICAgICAgIHRyYWNlVXNlcjogdHJ1ZSxcclxuICAgICAgfSlcclxuXHJcblxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIGVuc3VyZUxvZ2luKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHRoaXMuZ2xvYmFsRGF0YS5vcGVuaWQgIT09IG51bGwgJiYgdHlwZW9mICh0aGlzLmdsb2JhbERhdGEub3BlbmlkKSAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgIHd4LmNoZWNrU2Vzc2lvbih7XHJcbiAgICAgICAgICBzdWNjZXNzOiAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUodGhpcy5nbG9iYWxEYXRhLm9wZW5pZCk7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgZmFpbDogKCkgPT4ge1xyXG4gICAgICAgICAgICBkb0xvZ2luKCkudGhlbihvcGVuaWQgPT4geyByZXNvbHZlKG9wZW5pZCkgfSkuY2F0Y2goKGVycikgPT4geyByZWplY3QoZXJyKSB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRvTG9naW4oKS50aGVuKG9wZW5pZCA9PiB7IHJlc29sdmUob3BlbmlkKSB9KS5jYXRjaChlcnIgPT4geyByZWplY3QoZXJyKSB9KTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9LFxyXG5cclxuICBnZXRVc2VySW5mbygpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHd4LmdldFNldHRpbmcoe1xyXG4gICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgICBpZiAocmVzLmF1dGhTZXR0aW5nW1wic2NvcGUudXNlckluZm9cIl0pIHtcclxuICAgICAgICAgICAgdXBkYXRlVXNlckluZm8oKS50aGVuKChpbmZvKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZShpbmZvKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZW5zdXJlTG9naW4oKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVXNlckluZm8oKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKGluZm8pID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmVzb2x2ZShpbmZvKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIH0pXHJcblxyXG4gIH1cclxuXHJcbn0pXHJcblxyXG4vLyBjbGFzcyBteUFwcCBpbXBsZW1lbnRzIElNeUFwcCB7XHJcbi8vICAgZ2xvYmFsRGF0YTogSU15QXBwR2xvYmFsRGF0YSA9IHtcclxuLy8gICAgIHVzZUNsb3VkOiB0cnVlLFxyXG5cclxuLy8gICB9XHJcblxyXG4vLyAgIGFzeW5jIG9uTGF1bmNoKCkge1xyXG4vLyAgICAgaWYgKCF3eC5jbG91ZCkge1xyXG4vLyAgICAgICBjb25zb2xlLmVycm9yKCfor7fkvb/nlKggMi4yLjMg5oiW5Lul5LiK55qE5Z+656GA5bqT5Lul5L2/55So5LqR6IO95YqbJylcclxuLy8gICAgIH0gZWxzZSB7XHJcbi8vICAgICAgIHd4LmNsb3VkLmluaXQoe1xyXG4vLyAgICAgICAgIHRyYWNlVXNlcjogdHJ1ZSxcclxuLy8gICAgICAgfSlcclxuXHJcblxyXG4vLyAgICAgfVxyXG4vLyAgICAgLy8gdHJ5IHtcclxuLy8gICAgIC8vICAgYXdhaXQgdGhpcy5nZXRVc2VySW5mbygpXHJcbi8vICAgICAvLyB9IGNhdGNoIChlcnIpIHtcclxuLy8gICAgIC8vICAgY29uc29sZS5lcnJvcihlcnIpO1xyXG4vLyAgICAgLy8gfVxyXG4vLyAgICAgLy8gYXdhaXQgdGhpcy5nZXRVc2VySW5mbygpO1xyXG4vLyAgIH1cclxuXHJcbi8vICAgZW5zdXJlTG9naW4oKSB7XHJcbi8vICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4vLyAgICAgICBpZiAodGhpcy5nbG9iYWxEYXRhLm9wZW5pZCAhPT0gbnVsbCAmJiB0eXBlb2YgKHRoaXMuZ2xvYmFsRGF0YS5vcGVuaWQpICE9PSBcInVuZGVmaW5lZFwiKSB7XHJcbi8vICAgICAgICAgd3guY2hlY2tTZXNzaW9uKHtcclxuLy8gICAgICAgICAgIHN1Y2Nlc3M6ICgpID0+IHtcclxuLy8gICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmdsb2JhbERhdGEub3BlbmlkKTtcclxuLy8gICAgICAgICAgIH0sXHJcbi8vICAgICAgICAgICBmYWlsOiAoKSA9PiB7XHJcbi8vICAgICAgICAgICAgIGRvTG9naW4oKS50aGVuKG9wZW5pZCA9PiB7IHJlc29sdmUob3BlbmlkKSB9KS5jYXRjaCgoZXJyKSA9PiB7IHJlamVjdChlcnIpIH0pO1xyXG4vLyAgICAgICAgICAgfVxyXG4vLyAgICAgICAgIH0pXHJcbi8vICAgICAgIH0gZWxzZSB7XHJcbi8vICAgICAgICAgZG9Mb2dpbigpLnRoZW4ob3BlbmlkID0+IHsgcmVzb2x2ZShvcGVuaWQpIH0pLmNhdGNoKGVyciA9PiB7IHJlamVjdChlcnIpIH0pO1xyXG4vLyAgICAgICB9XHJcbi8vICAgICB9KVxyXG4vLyAgIH1cclxuXHJcbi8vICAgZ2V0VXNlckluZm8oKSB7XHJcbi8vICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4vLyAgICAgICB3eC5nZXRTZXR0aW5nKHtcclxuLy8gICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xyXG4vLyAgICAgICAgICAgaWYgKHJlcy5hdXRoU2V0dGluZ1tcInNjb3BlLnVzZXJJbmZvXCJdKSB7XHJcbi8vICAgICAgICAgICAgIHVwZGF0ZVVzZXJJbmZvKCkudGhlbigoaW5mbykgPT4ge1xyXG4vLyAgICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XHJcbi8vICAgICAgICAgICAgIH0pXHJcbi8vICAgICAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgICAgICB0aGlzLmVuc3VyZUxvZ2luKCkudGhlbigoKSA9PiB7XHJcbi8vICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVVzZXJJbmZvKClcclxuLy8gICAgICAgICAgICAgICAgIC50aGVuKChpbmZvKSA9PiB7XHJcbi8vICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XHJcbi8vICAgICAgICAgICAgICAgICB9KVxyXG4vLyAgICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgIH1cclxuLy8gICAgICAgICB9LFxyXG4vLyAgICAgICAgIGZhaWw6IGVyciA9PiB7XHJcbi8vICAgICAgICAgICByZWplY3QoZXJyKTtcclxuLy8gICAgICAgICB9XHJcbi8vICAgICAgIH0pXHJcbi8vICAgICB9KVxyXG5cclxuLy8gICB9XHJcbi8vIH1cclxuXHJcblxyXG5mdW5jdGlvbiBkb0xvZ2luKCkge1xyXG4gIGNvbnN0IGFwcCA9IGdldEFwcDxJTXlBcHA+KCk7XHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIHd4LmxvZ2luKHtcclxuICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuICAgICAgICBpZiAocmVzLmNvZGUpIHtcclxuICAgICAgICAgIGlmIChhcHAuZ2xvYmFsRGF0YS51c2VDbG91ZCkge1xyXG5cclxuICAgICAgICAgICAgZ2V0T3BlbklEQ2xvdWQoKS50aGVuKG9wZW5pZCA9PiB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZShvcGVuaWQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGdldE9wZW5JRFNlcnZlcihyZXMuY29kZSkudGhlbihvcGVuaWQgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUob3BlbmlkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgICBmYWlsOiBlcnIgPT4ge1xyXG4gICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9KTtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGdldE9wZW5JRENsb3VkKCkge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBjb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xyXG5cclxuICAgIHd4LmNsb3VkLmNhbGxGdW5jdGlvbih7XHJcbiAgICAgIG5hbWU6ICdsb2dpbicsXHJcbiAgICAgIGRhdGE6IHt9LFxyXG4gICAgICBzdWNjZXNzOiByZXMgPT4ge1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coJ1vkupHlh73mlbBdIFtsb2dpbl0gdXNlciBvcGVuaWQ6ICcsIHJlcy5yZXN1bHQpO1xyXG4gICAgICAgIGxldCBvcGVuaWQgPSByZXMucmVzdWx0Lm9wZW5pZDtcclxuICAgICAgICBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQgPSBvcGVuaWRcclxuICAgICAgICByZXNvbHZlKG9wZW5pZCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGZhaWw6IGVyciA9PiB7XHJcbiAgICAgICAgLy9jb25zb2xlLmVycm9yKCdb5LqR5Ye95pWwXSBbbG9naW5dIOiwg+eUqOWksei0pScsIGVycilcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRPcGVuSURTZXJ2ZXIoY29kZTogc3RyaW5nKSB7XHJcbiAgLy8gVE9ETzogaW1wbGVtZW50IFxyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBjb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xyXG4gICAgd3gucmVxdWVzdCh7XHJcbiAgICAgIHVybDogJ2h0dHBzOi94eHh4eC94eHh4JyxcclxuICAgICAgZGF0YToge1xyXG4gICAgICAgIGNvZGU6IGNvZGVcclxuICAgICAgfSxcclxuICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuICAgICAgICBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQgPSByZXMuZGF0YS5vcGVuaWQ7XHJcbiAgICAgICAgcmVzb2x2ZShyZXMuZGF0YSlcclxuICAgICAgfSxcclxuICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlVXNlckluZm8oKSB7XHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGNvbnN0IGFwcCA9IGdldEFwcDxJTXlBcHA+KCk7XHJcbiAgICB3eC5nZXRVc2VySW5mbyh7XHJcbiAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSByZXMudXNlckluZm87XHJcbiAgICAgICAgcmVzb2x2ZShyZXMudXNlckluZm8pO1xyXG4gICAgICB9LFxyXG4gICAgICBmYWlsOiBlcnIgPT4ge1xyXG4gICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9KVxyXG59XHJcblxyXG5cclxuIl19